---
groups:
  - name: concourse
    jobs:
      - 'build-concourse-latest-rc'
      - 'test-docker-image'
      - 'push-concourse-latest'

resources:
- name: docker-images-git
  type: git
  source:
    uri: https://github.com/ECSTeam/docker-images.git
    branch: master

- name: concourse-ubuntu-latest-rc
  type: docker-image
  source:
    username: ((docker-hub-user))
    password: ((docker-hub-password))
    repository: {{docker-hub-repo}}
    tag: latest-rc
- name: concourse-ubuntu-latest
  type: docker-image
  source:
    username: ((docker-hub-user))
    password: ((docker-hub-password))
    repository: {{docker-hub-repo}}
    tag: latest

jobs:
- name: build-concourse-latest-rc
  public: true
  plan:
  - get: docker-images-git
    trigger: true
  - put: concourse-ubuntu-latest-rc
    params:
      build: docker-images-git/concourse-ubuntu
- name: test-docker-image
  public: true
  plan:
  - get: docker-images-git
  - get: concourse-ubuntu-latest-rc
    passed: ['build-concourse-latest-rc']
    trigger: true

  - task: run
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: {{docker-hub-repo}}
          tag: latest-rc
      inputs:
      - name: docker-images-git
      run:
        path: docker-images-git/ci/scripts/test-docker.sh
- name: push-concourse-latest
  public: true
  plan:
  - get: concourse-ubuntu-latest-rc
    passed: ['test-docker-image']
    trigger: true
    params: { save: true }
  - put: concourse-ubuntu-latest
    params:
      load: concourse-ubuntu-latest-rc
